{% load static %}

{% load humanize%}
 


{% include 'ss/head.html' %}
{% include "ss/header.html" %}


    
    <article class="bangsp">
        <img id="product-image" src="{{ctsp.hinh_anh.first.hinh.url}}" alt="" class="sp">
        <section class="noidung">
           [New Chính Hãng] {{ctsp.ten_sp}}
           <p class="noidung1">
                &nbsp; -Thương hiệu: {{ ctsp.nhacungcap }} <br>
                &nbsp; -Mã sản phẩm: {{ ctsp.ma_sp }} <br>
                &nbsp; -Mô tả: {{ ctsp.mo_ta }} <br>
                &nbsp; -Giá tốt nhất thị trường <br>
                &nbsp; -Xem trực tiếp sản phẩm tại: 122/27/117/9/9 Tôn Đản Phường Khánh Hội TP.HCM  <br>
            </p>
           {%if ctsp.giam_gia%}
                    Giá: <span id='giatien'> <s style ="color: black; font-size:20px">{{ ctsp.gia | floatformat:0 | intcomma }} </s> 
                    &nbsp{{  ctsp.giam_gia | floatformat:0 | intcomma }} </span> <br>
                {%else%}
                    Giá: <span id='giatien'>
                    {{ ctsp.gia_ban | floatformat:0 | intcomma }} </span> <br>
                {%endif%}
           <p class="noidung1">
            {% if user.is_authenticated %}
    {% if user.is_staff %}
        
        <form action="{% url 'x' ctsp.ma_sp %}" method="post" style="margin-top:10px;">
            {% csrf_token %}
            <button class="o1 btn-card bi" type="submit" name='x'>Xóa sản phẩm</button> 
        </form>
         <form action="{% url 's' ctsp.ma_sp %}" method="post" style="margin-top:10px;">
            {% csrf_token %}
        <button class="o2 bi" type="submit" name='s'>Sửa sản phẩm</button>
        </form>
    {% else %}
        
        <form method="post" action="{% url 'tvg' %} " class="khung">
            {% csrf_token %}
            
            
            <input type="hidden" name="masp" value="{{ ctsp.ma_sp }}">

            
            <label class="noidung1">Size [kích thước]</label><br>
            <select name="size_id" id="size-select">
                <option value="">Chọn size</option>
                {% for s in soluong %}
                    <option value="{{ s.id }}" 
                            data-soluong="{{ s.so_luong }}" 
                            data-gia="{{ s.gia_tuy_chinh }}">
                        Size {{ s.size.size }}
                    </option>
                {% endfor %}
            </select>
            <span id="tonkho"></span><br>

            <label class="noidung1">Số lượng:</label><br>
            <div class="qty-control" style="display:flex; align-items:center; gap:6px; margin-bottom:8px;">
                <button type="button" id="decrease-btn" class="btn btn-sm btn-outline-secondary">-</button>
                <input type="number" name="sl" id="quantity-input" min="1" value="1" style="text-align:center; width:70px;" class="noidung1" readonly>
                <button type="button" id="increase-btn" class="btn btn-sm btn-outline-secondary">+</button>
            </div>

            <!-- Nút -->
            <button id="add-to-cart-btn" class="o1 btn-card bi bi-cart-plus" name="action" value="add" type="submit">
                Thêm 
            </button>
            <input type="hidden" id="action-input" name="action" value="add" style="display:none;">
            <button class="o2 bi bi-wallet2" type="submit" name="action" value="buy">
                Mua ngay
            </button>
        </form>
    {% endif %}
{% else %}
    <p class="noidung1">
        Hãy đăng nhập để mua hàng 
        <a href="{% url 'dn' %}">Tại đây</a>
    </p>
    <p class="noidung1">
        Hoặc tạo tài khoản mới 
        <a href="{% url 'dk' %}">Tại đây</a>
    </p>
{% endif %}
          
            
        </section>
    </article>



{% include "ss/footer.html" %}

{% comment %} tồn kho {% endcomment %}
<script>
 document.getElementById("size-select").addEventListener("change", function () {
    const selectedOption = this.options[this.selectedIndex];
    const soluong = selectedOption.dataset.soluong;
    const gia = selectedOption.dataset.gia;

    document.getElementById("tonkho").textContent = soluong ? `Tồn kho: ${soluong} sản phẩm` : '';

    if(gia){
      const giadoi = new Intl.NumberFormat('vi-VN').format(gia);
      document.getElementById("giatien").textContent = giadoi;
    }
});
</script>

<script>
// Nút số lượng (tăng/giảm)
const sizeSelectEl = document.getElementById('size-select');
const qtyInputEl = document.getElementById('quantity-input');
const incBtn = document.getElementById('increase-btn');
const decBtn = document.getElementById('decrease-btn');

function updateMaxFromSelected() {
    const opt = sizeSelectEl.options[sizeSelectEl.selectedIndex];
    const max = opt && opt.dataset && opt.dataset.soluong ? parseInt(opt.dataset.soluong, 10) : null;
    if (max !== null) {
        qtyInputEl.max = max;
        if (parseInt(qtyInputEl.value, 10) > max) qtyInputEl.value = max;
    } else {
        qtyInputEl.removeAttribute('max');
    }

    const current = parseInt(qtyInputEl.value || '1', 10);
    if (incBtn) incBtn.disabled = !!(max && current >= max);
    if (decBtn) decBtn.disabled = current <= 1;
}

if (sizeSelectEl) sizeSelectEl.addEventListener('change', updateMaxFromSelected);

if (incBtn) incBtn.addEventListener('click', () => {
    const max = qtyInputEl.max ? parseInt(qtyInputEl.max, 10) : null;
    let v = parseInt(qtyInputEl.value || '1', 10);
    if (max && v >= max) {
        alert(`Chỉ còn ${max} sản phẩm trong kho`);
        return;
    }
    v += 1;
    qtyInputEl.value = v;
    updateMaxFromSelected();
});

if (decBtn) decBtn.addEventListener('click', () => {
    let v = parseInt(qtyInputEl.value || '1', 10);
    if (v <= 1) {
        alert('Số lượng tối thiểu là 1');
        return;
    }
    v -= 1;
    qtyInputEl.value = v;
    updateMaxFromSelected();
});

// Khởi tạo
document.addEventListener('DOMContentLoaded', updateMaxFromSelected);

// Hoạt ảnh Fly-to-cart và cập nhật số lượng giỏ hàng
const addBtn = document.getElementById('add-to-cart-btn');
const productImg = document.getElementById('product-image');
const cartIcon = document.getElementById('cart-icon');
const cartCountEl = document.getElementById('cart_count');
const qtyInput = document.getElementById('quantity-input');

function animateToCart(imgEl, qty){
    if(!imgEl || !cartIcon) return Promise.resolve();
    const imgRect = imgEl.getBoundingClientRect();
    const cartRect = cartIcon.getBoundingClientRect();

    const clone = imgEl.cloneNode(true);
    clone.style.position = 'fixed';
    clone.style.left = imgRect.left + 'px';
    clone.style.top = imgRect.top + 'px';
    clone.style.width = imgRect.width + 'px';
    clone.style.height = imgRect.height + 'px';
    clone.style.transition = 'transform 0.7s ease-in-out, opacity 0.7s ease-in-out';
    clone.style.zIndex = 9999;
    clone.style.pointerEvents = 'none';
    document.body.appendChild(clone);

    const deltaX = (cartRect.left + cartRect.width/2) - (imgRect.left + imgRect.width/2);
    const deltaY = (cartRect.top + cartRect.height/2) - (imgRect.top + imgRect.height/2);
    requestAnimationFrame(() => {
        clone.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(0.2)`;
        clone.style.opacity = '0.6';
    });

    return new Promise(resolve => {
        clone.addEventListener('transitionend', () => {
            clone.remove();
            resolve();
        }, { once: true });
    });
}

addBtn && addBtn.addEventListener('click', async function(e){
    e.preventDefault(); 

    const form = this.closest('form');
    
    const selectedSize = sizeSelectEl ? sizeSelectEl.value : null;
    if (!selectedSize) {
        alert('Vui lòng chọn size giày trước khi thêm vào giỏ.');
        return; 
    }

    const selectedOpt = sizeSelectEl.options[sizeSelectEl.selectedIndex];
    const stock = selectedOpt && selectedOpt.dataset && selectedOpt.dataset.soluong ? parseInt(selectedOpt.dataset.soluong, 10) : null;

   
    if(stock === 0){
        return;
    }

    let qty = Math.max(1, parseInt(qtyInput.value || '1', 10));
    if(stock !== null && qty > stock){
        qty = stock;
        qtyInput.value = qty;
    }

    await animateToCart(productImg, qty);

   if(cartCountEl){
        const current = parseInt(cartCountEl.textContent) || 0;
        cartCountEl.textContent = current + qty; // 
   }
    

    if(form){
        const actionInput = document.getElementById('action-input');
        if(actionInput) actionInput.value = 'add';
        form.submit();
    }
});
</script>
